#!/usr/bin/env ruby
# frozen_string_literal: true

require "optparse"

require "esphome/cli/monitor"

log_level = :info
connection_log_level = :warn
device_log_level = :debug
dump_config = false
opts = OptionParser.new do |opts|
  opts.banner = <<~TEXT
    Usage: esphome-monitor ([<uri>] <device_name> | <address> <encryption_key>)

    Example: esphome-monitor http://localhost:6052/ my_device
      If URI is omitted, it defaults to http://localhost:6052/
  TEXT

  opts.on("--connection-log-level=VALUE", "Connection log level") do |v|
    connection_log_level = v
  end
  opts.on("--device-log-level=VALUE", "Device log level") do |v|
    device_log_level = v
  end
  opts.on("--log-level=VALUE", "Monitoring program log level") do |v|
    log_level = v
  end
  opts.on("--dump-config", "Dump device configuration on connect") do
    dump_config = true
  end
  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end
opts.parse!

if ARGV.size == 1
  uri = "http://localhost:6052/"
  device_name = ARGV[0]
elsif ARGV.size == 2 && ARGV[0].include?(":")
  uri, device_name = ARGV
elsif ARGV.size == 2
  address, encryption_key = ARGV
else
  warn opts
  exit(-1)
end

if uri
  require "esphome/dashboard"

  dashboard = ESPHome::Dashboard.new(uri)

  device = dashboard.devices.find { |d| d["name"] == device_name }
  unless device
    warn "Device not found: #{device_name}"
    exit 1
  end

  address = device["address"]
  encryption_key = dashboard.encryption_key(device["configuration"])
  unless encryption_key
    warn "No encryption key found for device #{device_name}"
    exit 1
  end
end

device = ESPHome::Device.new(address, encryption_key)

ESPHome::Cli::Monitor.run(device, connection_log_level:, device_log_level:, log_level:, dump_config:)
